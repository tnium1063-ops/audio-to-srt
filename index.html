<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini & OpenAI Audio Transcriber</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #0f172a; /* slate-900 */
      }
      .hidden {
        display: none;
      }
      /* Simple focus ring for accessibility */
      button:focus-visible, div[tabindex="0"]:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible {
        outline: 2px solid #38bdf8; /* sky-400 */
        outline-offset: 2px;
        border-radius: 0.375rem; /* rounded-md */
      }
      .preserve-whitespace {
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.27.0"
  }
}
</script>
</head>
  <body class="antialiased">
    <div id="root">
        <div class="min-h-screen bg-slate-900 text-white flex flex-col items-center p-4 sm:p-6 lg:p-8">
            <div class="w-full max-w-5xl mx-auto">
              <header class="text-center mb-8">
                <h1 class="text-4xl sm:text-5xl font-bold text-slate-100">Audio Transcriber</h1>
                <p class="mt-2 text-lg text-slate-400">Powered by Gemini, OpenAI & Bytez</p>
              </header>
      
              <main class="space-y-8 p-6 sm:p-8 bg-slate-800/50 rounded-xl shadow-2xl border border-slate-700">
                
                <div class="space-y-4">
                  <h2 class="text-xl font-semibold text-slate-200">1. Choose AI Provider</h2>
                   <select id="api-provider-select" class="w-full p-3 bg-slate-700 border border-slate-600 text-slate-200 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                      <option value="bytez" selected>Bytez</option>
                      <option value="gemini">Google Gemini</option>
                      <option value="openai">OpenAI Whisper</option>
                  </select>
                </div>

                <div class="space-y-4">
                  <h2 class="text-xl font-semibold text-slate-200">2. Enter Your API Key</h2>
                  <input type="password" id="api-key-input" placeholder="Paste your API key here..." class="w-full p-3 bg-slate-700 border border-slate-600 text-slate-200 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500" />
                  <p id="api-key-help-text" class="text-xs text-slate-500">
                      Your key is stored only in your browser.
                  </p>
                </div>

                <div class="space-y-4">
                  <h2 class="text-xl font-semibold text-slate-200">3. Select AI Model</h2>
                  <select id="model-select" class="w-full p-3 bg-slate-700 border border-slate-600 text-slate-200 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                      <!-- Models are populated by JS -->
                  </select>
                </div>

                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-slate-200">4. Provide Audio or Video Source</h2>
                    <!-- Tabs -->
                    <div class="flex border-b border-slate-700">
                      <button id="tab-file" class="input-tab-btn px-4 py-2 text-sm font-medium border-b-2">Upload File</button>
                      <button id="tab-url" class="input-tab-btn px-4 py-2 text-sm font-medium border-b-2">From URL</button>
                    </div>

                    <!-- File Upload Panel -->
                    <div id="file-upload-panel">
                      <div id="file-upload-area" tabindex="0" role="button" aria-label="Upload audio or video file" class="relative w-full border-2 border-dashed rounded-lg p-8 text-center transition-colors duration-300 border-slate-600 hover:border-sky-500 cursor-pointer">
                          <input type="file" id="file-input" accept="audio/*,video/*" class="hidden" />
                          <div id="upload-prompt-container" class="flex flex-col items-center justify-center space-y-4 text-slate-400">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21 21H3" /><path stroke-linecap="round" stroke-linejoin="round" d="M3 7.5L7.5 3m0 0L12 7.5M7.5 3v13.5m13.5 0L16.5 21m0 0L12 16.5m4.5 4.5V7.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M9 15l3-3m0 0l3 3m-3-3v12" /></svg>
                              <p class="text-lg">Drag & drop your audio or video file here</p>
                              <p class="text-sm">or click to select a file</p>
                          </div>
                      </div>
                      <p class="mt-2 text-xs text-slate-500">Note: Larger files may take longer to upload and process.</p>
                    </div>

                    <!-- URL Input Panel -->
                    <div id="url-upload-panel" class="hidden">
                      <div class="flex items-center space-x-2">
                        <input type="url" id="url-input" placeholder="Enter a direct audio or video URL..." class="w-full p-3 bg-slate-700 border border-slate-600 text-slate-200 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                      </div>
                      <p class="mt-2 text-xs text-slate-500">Note: URL must be publicly accessible. Processing large files may take several minutes.</p>
                    </div>
                    <p id="file-name-display" class="text-lg text-green-400 hidden truncate p-2 bg-slate-700/50 rounded-md"></p>
                </div>
      
                <div class="space-y-4">
                    <h2 class="text-xl font-semibold text-slate-200">5. Select Format</h2>
                    <div class="flex space-x-4">
                        <button id="format-btn-text" data-format="text" class="format-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-sky-500 text-white shadow-lg">TEXT</button>
                        <button id="format-btn-srt" data-format="srt" class="format-btn px-6 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-slate-700 text-slate-300 hover:bg-slate-600">SRT</button>
                    </div>
                </div>

                <div id="translate-section" class="space-y-4">
                    <h2 class="text-xl font-semibold text-slate-200">6. Translate (Optional)</h2>
                    <div class="flex items-center space-x-3 p-4 bg-slate-700/50 rounded-lg">
                        <input type="checkbox" id="translate-checkbox" class="h-5 w-5 rounded bg-slate-600 border-slate-500 text-sky-500 focus:ring-sky-500 cursor-pointer">
                        <label for="translate-checkbox" class="text-slate-300 cursor-pointer flex-grow">Translate transcription</label>
                        <select id="language-select" class="hidden ml-auto bg-slate-600 border border-slate-500 text-slate-200 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block w-full max-w-xs p-2.5">
                            <option value="English">English</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Indonesian">Indonesian</option>
                            <option value="Japanese">Japanese</option>
                            <option value="Korean">Korean</option>
                            <option value="Chinese (Mandarin)">Chinese (Mandarin)</option>
                        </select>
                    </div>
                </div>
                
                <div>
                  <button id="transcribe-btn" disabled class="w-full flex items-center justify-center px-6 py-3 bg-gradient-to-r from-sky-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:from-sky-600 hover:to-indigo-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105 disabled:transform-none">
                      <span id="transcribe-btn-content" class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM18 15.75l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 18l-1.035.259a3.375 3.375 0 00-2.456 2.456L18 21.75l-.259-1.035a3.375 3.375 0 00-2.456-2.456L14.25 18l1.035.259a3.375 3.375 0 002.456-2.456z" /></svg>
                        <span class="ml-2">Generate Transcription</span>
                      </span>
                      <span id="transcribe-spinner" class="hidden flex items-center justify-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        <span class="ml-2">Processing...</span>
                      </span>
                  </button>
                </div>
      
                <div id="error-display" class="hidden p-4 bg-red-900/50 border border-red-700 text-red-300 rounded-md preserve-whitespace"></div>
                
                <div id="result-section" class="hidden space-y-4 pt-4 border-t border-slate-700">
                   <h2 id="result-heading" class="text-xl font-semibold text-slate-200">7. Result</h2>
                   <div id="result-loader" class="hidden flex flex-col items-center justify-center p-8 bg-slate-800 rounded-md text-slate-400">
                     <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-sky-400"></div>
                     <p class="mt-4">Processing your file... Please wait.</p>
                   </div>
                   <div id="result-display" class="w-full space-y-4">
                     <!-- Single result view -->
                     <div id="single-result-container">
                       <textarea id="transcription-output" readonly class="w-full h-64 p-4 bg-slate-800 border border-slate-700 rounded-md text-slate-300 focus:ring-2 focus:ring-sky-500 focus:outline-none resize-y preserve-whitespace" placeholder="Transcription will appear here..."></textarea>
                       <div class="flex items-center justify-end space-x-4 mt-4">
                         <button id="copy-btn" class="flex items-center px-4 py-2 bg-slate-700 text-slate-300 rounded-md hover:bg-slate-600 transition-colors disabled:opacity-50" disabled>
                           <span id="copy-icon-container"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 0 011.5 .124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m9.375 0V9.375c0 .621-.504 1.125-1.125 1.125h-1.5" /></svg></span>
                           <span id="copy-btn-text">Copy</span>
                         </button>
                         <button id="download-btn" class="flex items-center px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-500 transition-colors disabled:opacity-50" disabled>
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                           <span id="download-btn-text">Download .text</span>
                         </button>
                       </div>
                     </div>
                     <!-- Table result view -->
                     <div id="table-result-container" class="hidden">
                        <div class="overflow-x-auto bg-slate-800 rounded-lg border border-slate-700">
                          <table class="w-full text-sm text-left text-slate-300">
                            <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                              <tr>
                                <th scope="col" class="px-6 py-3 w-1/2">Original Transcription</th>
                                <th scope="col" class="px-6 py-3 w-1/2">Translated Result</th>
                              </tr>
                            </thead>
                            <tbody id="result-table-body">
                              <!-- Rows will be injected by JS -->
                            </tbody>
                          </table>
                        </div>
                      </div>
                   </div>
                </div>
              </main>
              
              <footer class="text-center mt-8 text-slate-500 text-sm">
                  <p>&copy; 2024 Gemini Audio Transcriber. All rights reserved.</p>
              </footer>
            </div>
          </div>
    </div>
    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // --- DOM ELEMENTS (Grab all at once) ---
        const dom = {
            apiProviderSelect: document.getElementById('api-provider-select'),
            apiKeyInput: document.getElementById('api-key-input'),
            apiKeyHelpText: document.getElementById('api-key-help-text'),
            modelSelect: document.getElementById('model-select'),
            tabFile: document.getElementById('tab-file'),
            tabUrl: document.getElementById('tab-url'),
            fileUploadPanel: document.getElementById('file-upload-panel'),
            urlUploadPanel: document.getElementById('url-upload-panel'),
            urlInput: document.getElementById('url-input'),
            fileUploadArea: document.getElementById('file-upload-area'),
            fileInput: document.getElementById('file-input'),
            fileNameDisplay: document.getElementById('file-name-display'),
            formatBtns: document.querySelectorAll('.format-btn'),
            translateSection: document.getElementById('translate-section'),
            translateCheckbox: document.getElementById('translate-checkbox'),
            languageSelect: document.getElementById('language-select'),
            transcribeBtn: document.getElementById('transcribe-btn'),
            transcribeBtnContent: document.getElementById('transcribe-btn-content'),
            transcribeSpinner: document.getElementById('transcribe-spinner'),
            errorDisplay: document.getElementById('error-display'),
            resultSection: document.getElementById('result-section'),
            resultLoader: document.getElementById('result-loader'),
            resultDisplay: document.getElementById('result-display'),
            resultHeading: document.getElementById('result-heading'),
            singleResultContainer: document.getElementById('single-result-container'),
            tableResultContainer: document.getElementById('table-result-container'),
            resultTableBody: document.getElementById('result-table-body'),
            transcriptionOutput: document.getElementById('transcription-output'),
            copyBtn: document.getElementById('copy-btn'),
            copyIconContainer: document.getElementById('copy-icon-container'),
            copyBtnText: document.getElementById('copy-btn-text'),
            downloadBtn: document.getElementById('download-btn'),
            downloadBtnText: document.getElementById('download-btn-text'),
            footerYear: document.querySelector('footer p'),
        };

        // --- APP CONFIG ---
        const config = {
            models: {
                gemini: [
                    { value: 'gemini-2.5-pro', text: 'Gemini 2.5 Pro (Highest Quality)' },
                    { value: 'gemini-2.5-flash', text: 'Gemini 2.5 Flash (Fastest)' },
                ],
                openai: [
                    { value: 'whisper-1', text: 'Whisper-1 (High Quality & Fast)' },
                ],
                bytez: [
                    { value: 'whisper-1', text: 'Whisper-1 (via Bytez)' },
                ],
            }
        }

        // --- STATE MANAGEMENT ---
        const state = {
            apiProvider: 'bytez',
            apiKey: 'd2f1679b8da24c5ad3d4320d98f72355',
            model: 'whisper-1',
            audioFile: null,
            sourceUrl: '',
            originalTranscription: '',
            translatedTranscription: '',
            isLoading: false,
            errorMessage: '',
            format: 'text',
            translate: false,
            targetLanguage: 'English',
            inputType: 'file', // 'file' or 'url'
        };

        const setState = (updates) => {
            Object.assign(state, updates);
            render();
        };

        // --- ICONS (SVG STRINGS) ---
        const copyIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 0 011.5 .124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m9.375 0V9.375c0 .621-.504 1.125-1.125 1.125h-1.5" /></svg>`;
        const checkIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-green-400"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;

        // --- API SERVICE LOGIC ---
        const getGeminiPrompt = (format, shouldTranslate, lang) => {
            let basePrompt;
            let formatInstructions;

            if (format === 'srt') {
                formatInstructions = `
IMPORTANT INSTRUCTIONS:
1.  **Focus on Speech:** Prioritize transcribing human speech. If the audio is noisy, do your best to isolate and transcribe only the spoken words, ignoring background noise.
2.  **Output Format:** Provide the transcription in SRT (SubRip Text) format. The structure should be: subtitle index, timestamp, and text.
3.  **Timestamp Format:** The timestamp format is CRITICAL and MUST be exactly \`HH:MM:SS,ms --> HH:MM:SS,ms\` (hours, minutes, seconds, comma, milliseconds). For example: \`00:01:23,456 --> 00:01:25,789\`.
4.  **Granular Timestamps:** Create a new subtitle entry (with a new sequential number, timestamp, and text line) for every short phrase or clause. A good rule of thumb is to create a new entry after every comma or a natural pause in speech. Do not group multiple sentences or long clauses into a single subtitle block.
Ensure the final output strictly adheres to this SRT format. Do not include any extra explanations, comments, or introductory text.`;
            } else { // 'text' format
                formatInstructions = 'Prioritize transcribing human speech and ignore background noise as much as possible. Provide only the transcribed text, without any additional comments or explanations.';
            }

            if (shouldTranslate) {
                const translationInstruction = `
After generating the transcription, you must then translate the entire result into **${lang}**. Then, you MUST separate the original transcription and the translated result with this exact delimiter:
---TRANSLATION_SEPARATOR---

**Translation Rules:**
-   **Preserve Formatting:** If the format is SRT, you MUST maintain the exact SRT structure, including sequential numbering and timestamps. Only translate the text portion of each subtitle entry.
-   **Final Output Structure:** The final output must be structured as follows: [Original Transcription in requested format] ---TRANSLATION_SEPARATOR--- [Translated Transcription in the same format]. Do not include any other explanatory text.`;
                
                basePrompt = `You are an expert audio transcriptionist and translator. Your task is to first transcribe the audio from the provided file, and then translate it. The file may be a video; if so, process its audio track.

**Step 1: Transcribe**
${formatInstructions}

**Step 2: Translate & Format Output**
${translationInstruction}`;
            } else {
                basePrompt = `You are an expert audio transcriptionist. Your task is to transcribe the audio from the provided file. The file may be a video; if so, process its audio track.
${formatInstructions}`;
            }

            return basePrompt;
        };

        const generateTranscriptionGemini = async (mediaPart, transcriptionFormat, shouldTranslate, lang) => {
             const prompt = getGeminiPrompt(transcriptionFormat, shouldTranslate, lang);
 
             const ai = new GoogleGenAI({ apiKey: state.apiKey });
             const response = await ai.models.generateContent({
                 model: state.model,
                 contents: { parts: [{ text: prompt }, mediaPart] },
             });
             return response.text;
        };
        
        const generateTranscriptionWhisperCompatible = async (file, model, format, apiUrl, providerName) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('model', model);
            const responseFormat = format === 'text' ? 'json' : 'srt';
            formData.append('response_format', responseFormat);

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`
                },
                body: formData
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `An unknown error occurred with the ${providerName} API.`);
            }

            if (responseFormat === 'json') {
                const result = await response.json();
                return result.text;
            } else {
                return await response.text();
            }
        };


        // --- UI HELPER & RENDER FUNCTIONS ---
        const createActionButton = (type, id, text, content) => {
            const isDownload = type === 'download';
            const icon = isDownload ? 
                `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>` :
                copyIconSVG;

            const baseClasses = 'flex items-center px-4 py-2 rounded-md transition-colors disabled:opacity-50 text-sm';
            const colorClasses = isDownload ? 'bg-sky-600 text-white hover:bg-sky-500' : 'bg-slate-700 text-slate-300 hover:bg-slate-600';

            return `<button id="${type}-btn-${id}" data-content-id="${id}" class="${baseClasses} ${colorClasses}" ${!content ? 'disabled' : ''}>
                        <span id="icon-container-${type}-${id}">${icon}</span>
                        <span id="btn-text-${type}-${id}">${text}</span>
                    </button>`;
        };

        const populateTable = () => {
            dom.resultTableBody.innerHTML = '';
            const row = document.createElement('tr');
            row.className = 'bg-slate-800/50 align-top';

            const originalCell = document.createElement('td');
            originalCell.className = 'px-6 py-4';
            originalCell.innerHTML = `
                <div class="preserve-whitespace text-slate-300 mb-4 h-64 overflow-y-auto p-2 bg-slate-900/50 rounded-md border border-slate-700">${state.originalTranscription || ''}</div>
                <div class="flex items-center justify-end space-x-2">
                    ${createActionButton('copy', 'original', 'Copy', state.originalTranscription)}
                    ${createActionButton('download', 'original', `Download .${state.format}`, state.originalTranscription)}
                </div>`;
            
            const translatedCell = document.createElement('td');
            translatedCell.className = 'px-6 py-4';
            translatedCell.innerHTML = `
                <div class="preserve-whitespace text-slate-300 mb-4 h-64 overflow-y-auto p-2 bg-slate-900/50 rounded-md border border-slate-700">${state.translatedTranscription || ''}</div>
                <div class="flex items-center justify-end space-x-2">
                    ${createActionButton('copy', 'translated', 'Copy', state.translatedTranscription)}
                    ${createActionButton('download', 'translated', `Download .${state.format}`, state.translatedTranscription)}
                </div>`;
            
            row.appendChild(originalCell);
            row.appendChild(translatedCell);
            dom.resultTableBody.appendChild(row);
        };
        
        const render = () => {
            // Set API key input value from state
            dom.apiKeyInput.value = state.apiKey;
            
            // Button states
            dom.transcribeBtn.disabled = state.isLoading || (!state.audioFile && !state.sourceUrl) || !state.apiKey;
            dom.copyBtn.disabled = !state.originalTranscription || state.isLoading;
            dom.downloadBtn.disabled = !state.originalTranscription || state.isLoading;

            // Loading spinners
            dom.transcribeSpinner.classList.toggle('hidden', state.isLoading);
            dom.transcribeBtnContent.classList.toggle('hidden', !state.isLoading);

            // Error display
            dom.errorDisplay.classList.toggle('hidden', !state.errorMessage);
            dom.errorDisplay.textContent = state.errorMessage;
            if (state.errorMessage) {
                dom.resultSection.classList.add('hidden');
            }

            // API Provider specific UI changes
            if (state.apiProvider === 'gemini') {
                dom.apiKeyInput.placeholder = 'Paste your Gemini API key here...';
                dom.apiKeyHelpText.innerHTML = `Your key is stored only in your browser. Get your key from <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:underline">Google AI Studio</a>.`;
                dom.translateSection.classList.remove('hidden');
                dom.tabUrl.classList.remove('hidden');
            } else { // openai or bytez
                const isBytez = state.apiProvider === 'bytez';
                const providerName = isBytez ? 'Bytez' : 'OpenAI';
                const providerUrl = isBytez ? 'https://bytez.com/' : 'https://platform.openai.com/api-keys';
                const providerLinkText = isBytez ? 'Bytez.com' : 'OpenAI Platform';

                dom.apiKeyInput.placeholder = `Paste your ${providerName} API key here...`;
                dom.apiKeyHelpText.innerHTML = `Your key is stored only in your browser. Get your key from <a href="${providerUrl}" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:underline">${providerLinkText}</a>.`;
                dom.translateSection.classList.add('hidden');
                dom.tabUrl.classList.add('hidden');
                 if (state.inputType === 'url') {
                   setState({ inputType: 'file' });
                }
            }

            // Result section visibility
            if (state.originalTranscription) {
                dom.resultSection.classList.remove('hidden');
                dom.resultLoader.classList.add('hidden');
                dom.resultDisplay.classList.remove('hidden');
                if (state.translate && state.apiProvider === 'gemini') {
                    dom.singleResultContainer.classList.add('hidden');
                    dom.tableResultContainer.classList.remove('hidden');
                    dom.resultHeading.textContent = `7. Transcription & Translation Result`;
                    populateTable();
                } else {
                    dom.singleResultContainer.classList.remove('hidden');
                    dom.tableResultContainer.classList.add('hidden');
                    dom.resultHeading.textContent = `7. Transcription Result`;
                    dom.transcriptionOutput.value = state.originalTranscription;
                }
            } else if (!state.isLoading) {
                 dom.resultSection.classList.add('hidden');
            }

            // Update download button text
            dom.downloadBtnText.textContent = `Download .${state.format}`;

            // Tab styles and panel visibility
            if (state.inputType === 'file') {
                dom.tabFile.classList.add('border-sky-500', 'text-sky-400');
                dom.tabFile.classList.remove('border-transparent', 'text-slate-400', 'hover:border-slate-500');
                dom.tabUrl.classList.add('border-transparent', 'text-slate-400', 'hover:border-slate-500');
                dom.tabUrl.classList.remove('border-sky-500', 'text-sky-400');
                dom.fileUploadPanel.classList.remove('hidden');
                dom.urlUploadPanel.classList.add('hidden');
            } else { // 'url'
                dom.tabUrl.classList.add('border-sky-500', 'text-sky-400');
                dom.tabUrl.classList.remove('border-transparent', 'text-slate-400', 'hover:border-slate-500');
                dom.tabFile.classList.add('border-transparent', 'text-slate-400', 'hover:border-slate-500');
                dom.tabFile.classList.remove('border-sky-500', 'text-sky-400');
                dom.fileUploadPanel.classList.add('hidden');
                dom.urlUploadPanel.classList.remove('hidden');
            }
        };

        // --- EVENT HANDLERS & LOGIC ---

        const fileToGenerativePart = async (file) => {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        };

        const handleFileSelect = (file) => {
            if (!file) return;

            setState({ audioFile: file, sourceUrl: '', errorMessage: '', originalTranscription: '' });
            dom.fileNameDisplay.textContent = `Selected: ${file.name}`;
            dom.fileNameDisplay.classList.remove('hidden');
        };

        const handleCopy = async (text, btnIconContainer, btnTextEl) => {
            try {
                await navigator.clipboard.writeText(text);
                btnIconContainer.innerHTML = checkIconSVG;
                btnTextEl.textContent = 'Copied!';
                setTimeout(() => {
                    btnIconContainer.innerHTML = copyIconSVG;
                    btnTextEl.textContent = 'Copy';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
                btnTextEl.textContent = 'Error';
                 setTimeout(() => {
                    btnTextEl.textContent = 'Copy';
                }, 2000);
            }
        };

        const handleDownload = (text, format) => {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcription.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const handleTranscribe = async () => {
            setState({ isLoading: true, errorMessage: '', originalTranscription: '', translatedTranscription: '' });
            dom.resultSection.classList.remove('hidden');
            dom.resultLoader.classList.remove('hidden');
            dom.resultDisplay.classList.add('hidden');

            try {
                let responseText;
                if (state.apiProvider === 'gemini') {
                    let mediaPart;
                    if (state.inputType === 'file' && state.audioFile) {
                        mediaPart = await fileToGenerativePart(state.audioFile);
                    } else if (state.inputType === 'url' && state.sourceUrl) {
                        const urlPattern = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/;
                        if (!urlPattern.test(state.sourceUrl)) {
                            throw new Error('Please enter a valid URL.');
                        }
                        const extension = state.sourceUrl.split('.').pop().toLowerCase();
                        const mimeTypeMap = {
                            'mp3': 'audio/mpeg', 'wav': 'audio/wav', 'ogg': 'audio/ogg', 'm4a': 'audio/mp4',
                            'mp4': 'video/mp4', 'webm': 'video/webm', 'mov': 'video/quicktime'
                        };
                        const mimeType = mimeTypeMap[extension] || 'application/octet-stream';

                        mediaPart = { fileData: { mimeType: mimeType, uri: state.sourceUrl } };
                    } else {
                        throw new Error('Please provide an audio/video source.');
                    }
                    responseText = await generateTranscriptionGemini(mediaPart, state.format, state.translate, state.targetLanguage);
                } else { // openai or bytez
                    if (!state.audioFile) {
                         throw new Error('Please select a file to transcribe.');
                    }
                    const apiUrl = state.apiProvider === 'openai' 
                        ? 'https://api.openai.com/v1/audio/transcriptions'
                        : 'https://api.bytez.com/v1/audio/transcriptions';
                    const providerName = state.apiProvider === 'openai' ? 'OpenAI' : 'Bytez';
                    responseText = await generateTranscriptionWhisperCompatible(state.audioFile, state.model, state.format, apiUrl, providerName);
                }


                if (state.translate && state.apiProvider === 'gemini') {
                    const parts = responseText.split('---TRANSLATION_SEPARATOR---');
                    if (parts.length === 2) {
                        setState({
                            originalTranscription: parts[0].trim(),
                            translatedTranscription: parts[1].trim()
                        });
                    } else {
                       throw new Error('Translation failed. The model did not provide a translated version in the expected format.');
                    }
                } else {
                    setState({ originalTranscription: responseText.trim(), translatedTranscription: '' });
                }
            } catch (e) {
                console.error(e);
                let displayError = e.message;
                 if (displayError.includes('API key not valid') || (e.message && e.message.toLowerCase().includes('incorrect api key'))) {
                    displayError = 'Your API Key is not valid. Please check it and try again.';
                } else if (displayError.includes('Unsupported file uri')) {
                    displayError = `The provided URL could not be accessed. This might be because it's a private link, temporary, or on a server that blocks requests. Please try downloading the file and using the "Upload File" tab.`;
                    setState({ inputType: 'file' });
                }
                setState({ errorMessage: displayError });
            } finally {
                setState({ isLoading: false });
                dom.resultLoader.classList.add('hidden');
            }
        };

        const setupInitialModels = () => {
            const provider = state.apiProvider;
            dom.modelSelect.innerHTML = config.models[provider]
                .map(model => `<option value="${model.value}">${model.text}</option>`)
                .join('');
            dom.modelSelect.value = state.model;
        }

        // --- EVENT LISTENERS ---
        dom.apiProviderSelect.addEventListener('change', (e) => {
            const provider = e.target.value;
            const defaultModel = config.models[provider][0].value;
            
            const newState = {
                apiProvider: provider,
                model: defaultModel,
                apiKey: '', // Clear API key on provider change
                audioFile: null,
                sourceUrl: '',
                originalTranscription: '',
                translatedTranscription: '',
                errorMessage: '',
                inputType: 'file',
            };
            
            // If switching to Bytez, pre-fill the key again
            if (provider === 'bytez') {
                newState.apiKey = 'd2f1679b8da24c5ad3d4320d98f72355';
            }

            setState(newState);

            dom.modelSelect.innerHTML = config.models[provider]
                .map(model => `<option value="${model.value}">${model.text}</option>`)
                .join('');
            
            dom.fileInput.value = '';
            dom.urlInput.value = '';
            dom.fileNameDisplay.classList.add('hidden');
        });

        dom.apiKeyInput.addEventListener('input', (e) => {
          setState({ apiKey: e.target.value.trim() });
        });
        
        dom.modelSelect.addEventListener('change', (e) => setState({ model: e.target.value }));

        dom.urlInput.addEventListener('input', (e) => {
          setState({ sourceUrl: e.target.value.trim(), audioFile: null, originalTranscription: '' });
          if(e.target.value.trim()){
            dom.fileNameDisplay.textContent = `URL: ${e.target.value.trim()}`;
            dom.fileNameDisplay.classList.remove('hidden');
          } else {
            dom.fileNameDisplay.classList.add('hidden');
          }
        });

        dom.tabFile.addEventListener('click', () => setState({ inputType: 'file' }));
        dom.tabUrl.addEventListener('click', () => setState({ inputType: 'url' }));
        
        dom.fileUploadArea.addEventListener('click', () => dom.fileInput.click());
        dom.fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dom.fileUploadArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dom.fileUploadArea.addEventListener(eventName, () => dom.fileUploadArea.classList.add('border-sky-500', 'bg-slate-700/50'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dom.fileUploadArea.addEventListener(eventName, () => dom.fileUploadArea.classList.remove('border-sky-500', 'bg-slate-700/50'), false);
        });
        dom.fileUploadArea.addEventListener('drop', (e) => handleFileSelect(e.dataTransfer.files[0]));

        dom.formatBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const selectedFormat = btn.dataset.format;
                setState({ format: selectedFormat });
                dom.formatBtns.forEach(b => {
                    b.classList.remove('bg-sky-500', 'text-white', 'shadow-lg');
                    b.classList.add('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
                });
                btn.classList.add('bg-sky-500', 'text-white', 'shadow-lg');
                btn.classList.remove('bg-slate-700', 'text-slate-300', 'hover:bg-slate-600');
            });
        });

        dom.translateCheckbox.addEventListener('change', (e) => {
            setState({ translate: e.target.checked });
            dom.languageSelect.classList.toggle('hidden', !e.target.checked);
        });

        dom.languageSelect.addEventListener('change', (e) => setState({ targetLanguage: e.target.value }));

        dom.transcribeBtn.addEventListener('click', handleTranscribe);

        dom.copyBtn.addEventListener('click', () => handleCopy(state.originalTranscription, dom.copyIconContainer, dom.copyBtnText));
        dom.downloadBtn.addEventListener('click', () => handleDownload(state.originalTranscription, state.format));
        
        dom.resultTableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const contentId = button.dataset.contentId;
            const isCopy = button.id.startsWith('copy-btn');
            const isDownload = button.id.startsWith('download-btn');
            const contentToUse = contentId === 'original' ? state.originalTranscription : state.translatedTranscription;

            if (isCopy) {
                const iconContainer = button.querySelector(`#icon-container-copy-${contentId}`);
                const textEl = button.querySelector(`#btn-text-copy-${contentId}`);
                handleCopy(contentToUse, iconContainer, textEl);
            } else if (isDownload) {
                handleDownload(contentToUse, state.format);
            }
        });

        // --- INITIALIZATION ---
        dom.footerYear.textContent = `Â© ${new Date().getFullYear()} Gemini Audio Transcriber. All rights reserved.`;
        setupInitialModels();
        render(); // Initial Render

    </script>
  </body>
</html>